%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Storing the tiff stack in  a 3d mat and displayng a video of it
%    /!\ Requires "Image Processing Toolbox"

tiff_info = imfinfo('Z_stack_mouse1.tiff'); % return tiff structure, one element per image
tiff_stack = imread('Z_stack_mouse1.tiff', 1) ; % read in first image
%concatenate each successive tiff to tiff_stack
for ii = 2 : size(tiff_info, 1)
    temp_tiff = imread('Z_stack_mouse1.tiff', ii);
    tiff_stack = cat(3 , tiff_stack, temp_tiff);
end
%implay(tiff_stack) % playing a video of the stack

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%% Viewer3D toolbox is necessary : https://fr.mathworks.com/matlabcentral/fileexchange/21993-viewer3d

Iraw=double(tiff_stack);
Iraw=Iraw./max(max(max(Iraw)));          %Image normalization
S = size(Iraw);
%I=imadjustn(Iraw);                 %histogram equalization
sI=smooth3(I,'gaussian',3);     %applying a gaussian filter with a 3x3x3 window size with a default sd of 0.65
Isharp = zeros(S);
Iadjust = zeros(S);
low_in = 0;
high_in = 1;
low_out = 0;
high_out = 0.995;

Iadjust(:,:,1:69)=imadjustn(sI(:,:,1:69)); %adjusting images by subpart
Iadjust(:,:,70:S(3))=imadjustn(sI(:,:,70:S(3)));
se = strel('sphere',5);

% for i = 1:69
%     %Isharp(:,:,i) = imsharpen(sI(:,:,i));
%     Iadjust(:,:,i) = imadjust(sI(:,:,i),[low_in high_in],[low_out high_out]);
% end 
 for i = 70:S(3)
     %Iadjust(:,:,i) = imsharpen(sI(:,:,i));
     %Iadjust(:,:,i) = imadjust(sI(:,:,i),[low_in high_in],[low_out high_out]);
     Iadjust(:,:,i)=edge(Iadjust(:,:,i),'Prewitt');
     
 end 

Ifinal(:,:,i)= imclose(Iadjust(:,:,i),se);
Ifinal(:,:,70:S(3))=smooth3(Ifinal(:,:,70:S(3)),'gaussian',9);
viewer3d(Ifinal(:,:,70:S(3)))                    %3D rendering
 
%look for the optic fiber between the frames 70 and 130
                
            
